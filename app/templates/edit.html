{% extends 'base.html' %}
{% from "macro.html" import render_field_with_errors %}

{% block styles %}
    {{ super() }}
    {% if post.is_markdown %}
      <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='simplemde/simplemde.min.css') }}">
      <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css">
    {% endif %}

    <style>
        .navbar {
            background-color: #6f7782;
        }
        footer.page-footer {
            background-color: #6f7782;
        }
    </style>
{% endblock styles %}

{% block page_content %}
    <div class="row min_content">
        <!-- Main List -->
        <div class="col-lg-12 col-12">
            <div class="card">
                <!-- Card content -->
                <form class="card-body" method="POST"
                      action="{{ url_for('posts.edit_post', post_slug=post.slug) }}">
                    {{ form.csrf_token }}
                    <div class="row">
                      <!-- Grid column -->
                      <div class="col-md-9">
                        <div class="row">
                            <div class="col-md-6" style="padding-right: 5px;">
                                {{ render_field_with_errors(form.title, necessary=True) }}
                            </div>
                            <div class="col-md-6" style="padding-left: 5px;">
                                {{ render_field_with_errors(form.background_image_url, necessary=True) }}
                            </div>
                        </div>

                        {% if post.is_markdown %}
                          {% include "_markdown.html" %}
                        {% else %}
                          {% include "_ckeditor.html" %}
                        {% endif %}
                      </div>
                      <!-- Grid column -->

                      <!-- Grid column -->
                      <div class="col-md-3">
                          <div class="form-group">
                              {{ form.category.label }}
                              <span class="red-text">*</span>
                              <span data-toggle="modal" data-target="#create_category" style="display: inline-block;margin-left: 5px;vertical-align: top; margin-top: -5px;">
                                  <i class="fas fa-plus-circle" style="color: #3f51b5; font-size: 12px;"></i>
                              </span>
                              {{ form.category }}
                              {% if form.category.errors %}
                                  <ul>
                                  {% for error in form.category.errors %}
                                    <li>
                                        <small class="form-text text-muted mb-4">{{ error }}</small>
                                    </li>
                                  {% endfor %}
                                  </ul>
                              {% endif %}
                          </div>

                          <div class="form-group">
                              {{ form.collection.label }}
                              <span data-toggle="modal" data-target="#create_collection" style="display: inline-block;margin-left: 5px;vertical-align: top; margin-top: -5px;">
                                  <i class="fas fa-plus-circle" style="color: #3f51b5; font-size: 12px;"></i>
                              </span>
                              {{ form.collection }}
                              {% if form.collection.errors %}
                                  <ul>
                                  {% for error in form.collection.errors %}
                                    <li>
                                        <small class="form-text text-muted mb-4">{{ error }}</small>
                                    </li>
                                  {% endfor %}
                                  </ul>
                              {% endif %}
                          </div>

                          <div class="form-group">
                            {{ form.tags.label }}
                            <span class="red-text">*</span>
                            <span data-toggle="modal" data-target="#create_tag" style="display: inline-block;margin-left: 5px;vertical-align: top; margin-top: -5px;">
                                <i class="fas fa-plus-circle" style="color: #3f51b5; font-size: 12px;"></i>
                            </span>
                            {{ form.tags }}
                            {% if form.tags.errors %}
                                <ul>
                                  {% for error in form.tags.errors %}
                                    <li>
                                        <small class="form-text text-muted mb-4">{{ error }}</small>
                                    </li>
                                  {% endfor %}
                                </ul>
                            {% endif %}
                          </div>

                          <div class="form-group">
                              {{ form.deny_comment }}
                              {{ form.deny_comment.label }}
                          </div>
                          <div class="form-group">
                              {{ form.privacy }}
                              {{ form.privacy.label }}
                          </div>
                      </div>
                      <!-- Grid column -->
                    </div>

                    <div class="btn-group">
                        <div class="form-group">
                            {{ form.publish_submit }}
                        </div>
                        <div class="form-group ml-1">
                            {{ form.save_submit }}
                        </div>
                    </div>
                </form>
                <div class="modal fade" style="z-index: 11112;" id="create_category" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel"
                     aria-hidden="true">
                    <div class="modal-dialog modal-full-height modal-right modal-notify modal-info">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h6 class="modal-title" id="exampleModalLabel1">{{ _("Creat a new category") }}</h6>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form class="mt-3" method="POST" action="{{ url_for('posts.create_category') }}">
                                    {{ create_category_form.csrf_token }}
                                    {{ render_field_with_errors(create_category_form.name) }}

                                    <div style="position: fixed;right: 0;bottom: 0;">
                                        <button type="button" class="btn btn-secondary waves-effect waves-light" data-dismiss="modal">{{ _("Close") }}</button>
                                        <button type="submit" class="btn btn-primary waves-effect waves-light">{{ _("Save") }}</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" style="z-index: 11112;" id="create_tag" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel"
                     aria-hidden="true">
                    <div class="modal-dialog modal-full-height modal-right modal-notify modal-info">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h6 class="modal-title" id="exampleModalLabel2">{{ _("Creat a new tag") }}</h6>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form class="mt-3" method="POST" action="{{ url_for('posts.create_tag') }}">
                                    {{ create_tag_form.csrf_token }}
                                    {{ render_field_with_errors(create_tag_form.name) }}

                                    <div style="position: fixed;right: 0;bottom: 0;">
                                        <button type="button" class="btn btn-secondary waves-effect waves-light" data-dismiss="modal">{{ _("Close") }}</button>
                                        <button type="submit" class="btn btn-primary waves-effect waves-light">{{ _("Save") }}</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" style="z-index: 11112;" id="create_collection" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel"
                     aria-hidden="true">
                    <div class="modal-dialog modal-full-height modal-right modal-notify modal-info">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h6 class="modal-title" id="exampleModalLabel3">{{ _("Creat a new topic") }}</h6>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form class="mt-3" method="POST" action="{{ url_for('posts.create_collection') }}">
                                    {{ create_collection_form.csrf_token }}
                                    {{ render_field_with_errors(create_collection_form.name) }}
                                    {{ render_field_with_errors(create_collection_form.description) }}
                                    {{ render_field_with_errors(create_collection_form.background) }}

                                    <div style="position: fixed;right: 0;bottom: 0;">
                                        <button type="button" class="btn btn-secondary waves-effect waves-light" data-dismiss="modal">{{ _("Close") }}</button>
                                        <button type="submit" class="btn btn-primary waves-effect waves-light">{{ _("Save") }}</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Main List -->
    </div>
{% endblock page_content %}

{% block scripts %}
    {{ super() }}

    {% if post.is_markdown %}
        <script src="{{ url_for('static', filename='simplemde/simplemde.min.js') }}"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
        <script>
            var simplemde = new SimpleMDE({
                element: document.getElementById("body"),
                renderingConfig: {
                    singleLineBreaks: false,
                    codeSyntaxHighlighting: true,
                }
            });
        </script>
    {% else %}
{#        <script src="{{ url_for('static', filename='ckeditor_standard/ckeditor.js') }}"></script>#}
{#        {{ ckeditor.config(name='body') }}#}

        <script type="text/javascript" charset="UTF-8" src="{{ url_for('static', filename='ueditor/ueditor.config.js') }}"></script>
        <script type="text/javascript" charset="UTF-8" src="{{ url_for('static', filename='ueditor/ueditor.all.js') }}"></script>
        <script type="text/javascript" charset="UTF-8" src="{{ url_for('static', filename='ueditor/lang/zh-cn/zh-cn.js') }}"></script>

        <script type="text/javascript">
            var ue = UE.getEditor('editor', {
                serverUrl: "/files/ueditor_upload"
            });

            ue.ready(function() {
                var textarea = document.getElementById("body");
                ue.setContent(textarea.value);
            });

            $(function(){
                $("form").submit(function(){
                    $("textarea[name=body]").val(ue.getContent());
                    return true;
                })
            });
        </script>
    {% endif %}
{% endblock %}
