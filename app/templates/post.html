{% extends 'base.html' %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/post.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/highlight.css') }}">

    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='PhotoSwipe/photoswipe.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='PhotoSwipe/default-skin/default-skin.css') }}">

    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='toc-helper/css/toc-helper.min.css') }}">
    <style>
    .navbar {
        background-color: #6f7782;
    }
    footer.page-footer {
        background-color: #6f7782;
    }

    .blog-body img {
        max-width: 100%;
    }

    #toc {
        position: fixed;
        right: 0;
        z-index: 1030;
        border-radius: 0;
        margin-bottom: 0;
    }

    #toc-btn {
        position: fixed;
        right: 10px;
        bottom: 105px;
        z-index: 11111;
        padding-top: 15px;
        margin-bottom: 0;
        cursor: pointer;
        text-align: center;
        line-height: 32px;
    }

    </style>
{% endblock styles %}

{% block navbar_attribs %}fixed-top{% endblock navbar_attribs %}

{% block page_content %}
    <div class="row" style="margin-top: 60px;">
        <!-- Main List -->
        <div class="col-lg-9 col-12 mt-1">
          {% include 'pswp.html' %}

          <!--Section: Blog v.4-->
          <div class="card">
              <div class="card-body">
                  <!--Grid row-->
                  <div class="row mb-4">
                      <div class="col-md-12">
                        <section class="blog-body section pb-3 fadeIn">
                            <div class="text-center">
                              <h3 class="card-title">
                                <strong>
                                  {{ post.title }}
                                </strong>
                                {% if post.is_privacy %}
                                  <span class="Label Label--outline v-align-middle ml-1" style="vertical-align: top; margin-top: 5px;">
                                    Private
                                  </span>
                                {% endif %}
                              </h3>
                              <p class="dark-grey-text" style="font-size: 15px;">
                                  <span data-toggle="tooltip" data-placement="top"
                                        title="{{ post.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}">
                                      {{ moment(post.timestamp, local=True).fromNow() }}
                                  </span>

                                  <span class="post-item">
                                      <i class="fas fa-eye"></i> {{ post.visit_count }}
                                  </span>

                                  <span class="post-item">
                                      <a href="#comments" class="dark-grey-text">
                                        <i class="far fa-comments"></i> {{ post.comments|length }}
                                      </a>
                                  </span>
                              </p>
                            </div>

                            <div class="dark-grey-text mb-3 mt-4 mx-4">
                              <div data-toc="#toc" id="articleContent">{{ post.body|safe }}</div>

                              <div class="row mb-3">
                                  <div class="col-12">
                                      {% if current_user.is_admin %}
                                      <div class="btn-group float-right" role="group">
                                          <a href="{{ url_for('posts.edit_post', post_slug=post.slug) }}">
                                              <button type="submit" class="btn btn-sm btn-outline-primary shadow-none">
                                                  {{ _("Edit") }}
                                              </button>
                                          </a>
                                          <form method="POST" action="{{ url_for('posts.delete_post', post_slug=post.slug) }}" onclick="return del()">
                                              {{ operate_form.csrf_token }}
                                              <button type="submit" class="btn btn-sm btn-outline-danger shadow-none ml-0">
                                                  {{ _("Delete") }}
                                              </button>
                                          </form>
                                      </div>
                                      {% endif %}
                                  </div>
                              </div>

                              <div class="mb-5 justify-content-end">
                                  <a class="float-left" href="{{ url_for('posts.posts') }}">
                                      <i class="fas fa-arrow-circle-left"></i>
                                  </a>

                                  <span class="float-right">
                                      <span class="badge badge-secondary">{{ post.category.name }}</span>
                                      {% for tag in post.tags %}
                                        <span class="badge badge-info">{{ tag.name }}</span>
                                      {% endfor %}
                                  </span>
                              </div>
                            </div>
                        </section>

                        {% if post and post.collection %}
                        <hr>
                        <section class="section pb-3 fadeIn">
                            <!--  Card -->
                            <div class="dark-grey-text mb-5 mt-4 mx-4">
                              <div class="text-center mb-4">
                                  <h3 class="font-weight-bold pt-3 mb-5">
                                      {{ _("RELATED POSTS") }} <span class="badge pink">{{ post.collection.posts|length }}</span>
                                  </h3>
                              </div>

                              {% for post in post.collection.posts %}
                                <div class="row mb-4">
                                  <!-- Excerpt -->
                                  <div class="col-12">
                                    <h6 class="mt-0">
                                      <a href="{{ url_for('posts.post', post_slug=post.slug) }}" class="dark-grey-text">
                                        <strong>{{ post.title }}</strong>
                                      </a>
                                    </h6>

                                    <div class="post-data">
                                      <p class="font-small grey-text mb-0">
                                        <i class="far fa-clock"></i>
                                        <span data-toggle="tooltip" data-placement="top"
                                              title="{{ post.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}">
                                            {{ moment(post.timestamp).format('LL') }}
                                        </span>
                                      </p>
                                    </div>
                                  </div>
                                  <!--  Excerpt -->
                                </div>

                              {% endfor %}
                            </div>
                        </section>
                        {% endif %}

                        <hr>
                        <section id="comments" class="section pb-3 fadeIn">
                            <div class="comments-list text-center text-md-left mb-3 mt-5 mx-4">
                              <div class="text-center mb-4">
                                <h3 class="font-weight-bold pt-3 mb-5">
                                    {{ _("Comments") }} <span class="badge pink">{{ post.comments|length }}</span>
                                </h3>
                              </div>

                              {% for comment in post.comments %}
                                  <div class="row mb-4">
                                    <!--Content column-->
                                    <div class="col-md-10 col-12">
                                      <h5 class="user-name font-weight-bold">{{ comment.author }}</h5>
                                      <div class="mt-2">
                                        <ul class="list-unstyled">
                                          <li class="comment-date font-small grey-text">
                                              <i class="far fa-clock"></i>
                                              <span data-toggle="tooltip" data-placement="top"
                                                  title="{{ comment.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}">
                                                {{ moment(comment.timestamp).format('LL') }}
                                              </span>
                                          </li>
                                        </ul>
                                      </div>
                                      <p class="dark-grey-text article">
                                          {{ comment.body }}
                                      </p>
                                    </div>
                                    {% if current_user.is_admin %}
                                    <div class="col-md-2">
                                        <form class="float-right" method="POST" action="{{ url_for('posts.delete_comment', comment_id=comment.id) }}" onclick="return del()">
                                          {{ operate_form.csrf_token }}
                                          <button type="submit" class="btn btn-sm btn-outline-danger shadow-none ml-0">
                                              {{ _("Delete") }}
                                          </button>
                                        </form>
                                    </div>
                                    {% endif %}
                                    <!--/.Content column-->
                                  </div>
                              {% endfor %}
                            </div>
                        </section>

                        {% if not post.deny_comment %}
                        <hr>
                        <section class="section mb-4 fadeIn">
                            <h3 class="font-weight-bold text-center my-5">{{ _("Leave a reply") }}</h3>
                            <form class="card-body" method="POST" action="{{ url_for('posts.create_comment', post_slug=post.slug) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <!-- Grid row -->
                                <div class="row">

                                  <!-- Grid column -->
                                  <div class="col-lg-6 col-md-12 mb-4">

                                    <div class="input-group md-form form-sm form-3 pl-0">
                                      <div class="input-group-prepend">
                                        <span class="input-group-text white black-text" id="basic-addon8">1</span>
                                      </div>
                                      <input type="text" name="author" required class="form-control mt-0 black-border rgba-white-strong" placeholder="{{ _('Name') }}" aria-describedby="basic-addon9">
                                    </div>

                                  </div>
                                  <!-- Grid column -->

                                  <!-- Grid column -->
                                  <div class="col-lg-6 col-md-6 mb-4">

                                    <div class="input-group md-form form-sm form-3 pl-0">
                                      <div class="input-group-prepend">
                                        <span class="input-group-text white black-text" id="basic-addon9">2</span>
                                      </div>
                                      <input type="text" name="email" required class="form-control mt-0 black-border rgba-white-strong" placeholder="{{ _('Email') }}" aria-describedby="basic-addon9">
                                    </div>

                                  </div>
                                  <!-- Grid column -->

                                </div>
                                <!-- Grid row -->

                                <!-- Grid row -->
                                <div class="row">

                                  <div class="col-12 mt-1">
                                    <div class="form-group basic-textarea">

                                      <textarea name="body" class="form-control" required id="exampleFormControlTextarea6" rows="5" placeholder="{{ _('Write something here...') }}"></textarea>
                                    </div>

                                    <div class="text-right">
                                      <button class="btn btn-primary btn-sm waves-effect waves-light">{{ _("Submit") }}</button>
                                    </div>
                                  </div>

                                </div>
                                <!-- Grid row -->
                            </form>
                        </section>
                        {% endif %}
                      </div>
                </div>
                <!--Grid row-->
              </div>
          </div>

          <!--Section: Blog v.4-->
        </div>
        {% include "sidebar.html" %}
    </div>

    <div id="toc"></div>

    {% include "tail.html" %}

    <div id="toc-btn">
        <span class="btn-floating btn-sm btn-light-green text-center shadow-none">
            <i class="fa fa-list" style="padding-top: 12px;font-size: 20px;"></i>
        </span>
    </div>
{% endblock page_content %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='PhotoSwipe/photoswipe.min.js') }}"></script>
    <script src="{{ url_for('static', filename='PhotoSwipe/photoswipe-ui-default.min.js') }}"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
    <script src="{{ url_for('static', filename='js/custom.js') }}"></script>
    <script src="{{ url_for('static', filename='toc-helper/js/toc-helper.min.js') }}"></script>
    <script type="text/javascript">
        hljs.initHighlightingOnLoad();
        new TocHelper(
            {
                tocFixed: {
                    top: 42,
                    left: 0
                }
            }
           ).reset();

        function del(){
            if(!confirm("Are you Sure delete this post?")){
                window.event.returnValue = false;
            }
        }

        var isHiden = true;
        $(function(){
            var toc = document.getElementById('toc');
            $('#toc-btn').click(function () {
                if(isHiden){
                    toc.style.display="block";
                    // timer_hide_toc = auto_hide_toc();
                }else{
                    // clearTimeout(timer_hide_toc);
                    toc.style.display="none";
                }
                isHiden = !isHiden;
            });
        });

        function auto_hide_toc(){
            return setTimeout(function () {
                if(!isHiden){
                    toc.style.display="none";
                    isHiden = !isHiden;
                }
            }, 10000);
        }
        // var timer_hide_toc = auto_hide_toc();
    </script>

    <script async defer>
        $('#articleContent').on('copy', function (e) {

            // IE8 or earlier browser is 'undefined'
            if (typeof window.getSelection === 'undefined') return;

            const selection = window.getSelection();
            const selectRange = selection.getRangeAt(0);

            let textData = selectRange.toString();

            const node = document.createElement('div')
            node.appendChild(selectRange.cloneContents())

            let htmlData = node.innerHTML

            if (textData.length < 100) {
                return
            }
            const url = location.href

            const copyright = '本文章著作权归作者所有，任何形式的转载都请注明出处。'

            const appendText = ''
                + '\n-------------------------------\n'
                + '来源：May Blog\n'
                + '文章链接：' + url + '\n'
                + copyright + '\n\n'

            //文本格式附加版权信息
            textData += appendText

            //html格式附加版权信息
            htmlData = '<div>' + htmlData + appendText.replace(/\n/g, '<br/>') + '</div>'
            if (window.clipboardData) {
                window.clipboardData.setData("Text", textData);
                return false;
            }
            node.innerHTML = htmlData
            node.style.position = "absolute"
            node.style.left = "-99999px"
            document.body.appendChild(node)

            selection.selectAllChildren(node)
            setTimeout(function () {
                document.body.removeChild(node)
            }, 0)
        });
    </script>
{% endblock %}
